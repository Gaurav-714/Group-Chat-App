<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat App</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        .chat {
            border: 2px solid gray;
            width: 700px;
            height: 450px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            padding: 10px;
        }

        .message {
            padding: 5px 10px;
            margin: 5px 0;
            border-radius: 5px;
            max-width: 80%;
        }

        .server-message {
            background-color: #e1f5fe;
            align-self: flex-start;
        }

        .user-message {
            background-color: #d1f0d7;
            align-self: flex-end;
        }
    </style>
</head>

<body class="d-flex flex-column align-items-center justify-content-center">

    <!-- Chat Box -->
    <div class="chat mt-4 rounded" id="chat-log">
        {% for chat in chats %}
        <div class="message {% if chat.sender == request.user %}user-message{% else %}server-message{% endif %}">
            {{ chat.content }}
        </div>
        {% endfor %}
    </div>

    <!-- Input Box -->
    <div class="input-group mt-4 w-50">
        <input type="text" id="message-input" class="form-control" placeholder="Type Your Message Here...">
        <button class="btn btn-primary" id="send-message">Send</button>
    </div>

    <!-- WebSocket Script -->
    <script>
        // var ws = new WebSocket('ws://127.0.0.1:8000/ws/chat/{{ group_name }}/');

        var groupName = "{{ group_name }}";
        var ws = new WebSocket('ws://' + window.location.host + '/ws/chat/' + groupName + '/');

        ws.onopen = function () {
            console.log('‚úÖ WebSocket Connection Opened');
        };

        ws.onmessage = function (event) {
            var data = JSON.parse(event.data);
            console.log('üì© Message Received:', data.message);

            // Check if message is from the user or another client
            var sender = data.sender === "user" ? "user" : "server";
            displayMessage(data.message, sender);
        };

        ws.onerror = function (error) {
            console.error('‚ùå WebSocket Error:', error);
        };

        ws.onclose = function () {
            console.warn('‚ö†Ô∏è WebSocket Connection Closed');
        };

        document.getElementById('send-message').addEventListener('click', sendMessage);
        document.getElementById('message-input').addEventListener('keydown', function (event) {
            if (event.key === "Enter") sendMessage();
        });

        function sendMessage() {
            var messageInput = document.getElementById('message-input');
            var message = messageInput.value.trim();

            if (message !== "") {
                if (ws.readyState === WebSocket.OPEN) {
                    let messageData = JSON.stringify({ 'message': message, 'sender': 'user' });
                    ws.send(messageData);

                    console.log('üì§ Sent Message:', message);

                    // Display user messages instantly
                    displayMessage(message, "user");

                    messageInput.value = "";
                } else {
                    console.error("‚ö†Ô∏è WebSocket is not open. Message not sent.");
                }
            }
        }

        function displayMessage(message, sender) {
            var chatLog = document.getElementById('chat-log');
            var messageElement = document.createElement('div');

            messageElement.textContent = message;
            messageElement.classList.add("message");

            if (sender === "server") {
                messageElement.classList.add("server-message");
            } else {
                messageElement.classList.add("user-message");
            }

            chatLog.appendChild(messageElement);
            chatLog.scrollTop = chatLog.scrollHeight; // Auto-scroll to latest message
        }

    </script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</body>

</html>